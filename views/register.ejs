<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원가입</title>
  <!-- font CDN -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: rgb(26, 31, 39);
      color: white;
      font-family: 'Noto Sans KR', sans-serif;
    }

    form {
      margin: 0 auto;
      width: 650px;
    }

    .register-div div {
      text-align: center;
      font-size: 25px;
      padding-bottom: 30px;
    }

    .register-form .form-required {
      text-align: right;
      margin: 0 auto;
    }

    .register-form fieldset {
      border: 0;
      padding: 10px;
    }

    .register-form .form-div {
      display: flex;
      padding: 5px;
      margin: 10px 20px;
    }

    .register-form .form-item {
      width: 130px;
      padding: 5px;
    }

    .register-form input {
      width: 350px;
      margin-right: 10px;
      height: 40px;
      border: 1px solid rgb(221, 221, 221);
      border-radius: 4px;
      padding: 0px 11px 0px 15px;
      background-color: transparent;
      color: white;
    }

    .register-form .check-btn,
    .profile-box label,
    .profile-box button {
      width: 80px;
      height: 42px;
      border-radius: 4px;
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #FF9671;
      color: white;
      font-size: 14px;
    }

    .register-form .form-div-btn {
      display: flex;
      justify-content: center;
    }

    .register-form .guide {
      font-size: 13px;
      color: skyblue;
      padding: 10px 0;
      margin: 0;
    }

    #dynamicFile {
      display: none;
    }

    #preview {
      /* background-image: url('/static/img/profileBasic.png'); */
      background-size: 170px;
      width: 170px;
      height: 170px;
      border-radius: 50%;
      border: 1px solid gray;
      color: transparent;
      margin-bottom: 10px;
      margin-left: 35px;
    }

    form input::file-selector-button {
      display: none;
    }

    .profile-box input[type="file"] {
      padding: 0;
    }

    .profile-box label{ 
      display: inline-block;
      background-color: rgba(255, 255, 255, 0.548);
      cursor: pointer;
      width: 45px;
      height: 45px;
      margin: 5px 0 5px;
      background-image: url("../static/img/img.png");
      background-size: 36px;
      background-repeat: no-repeat;
      background-position: center;
      position: relative;
      right: 50px;
      border-radius: 50%;
    }
    
    .profile-img {
      width: 170px;
      height: 170px;
      border-radius: 50%;
      border: 1px solid gray;
    }

    .profile-div {
      height: 180px;
    }

    .back-main {
      height: 50px;
      padding-left: 20px;
      display: flex;
      align-items: center;
    }

    .back-main a {
      color: white;
      text-decoration: none;
    }

    .profile-box .profile-save-btn {
      display: none;
    }

    .profile-box {
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
    }

  </style>
  <!-- axios CDN -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- 다음주소검색 api -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
  <div class="back-main">
    <a href="/login">뒤로가기</a>
  </div>
  <form class="register-form" name="register-form">
    <div class="register-div">
      <div>모임에 참여해볼까요?</div>
    </div>
    <fieldset>
      <div class="profile-box form-div">
        <!-- <p class="form-item"></p> -->
        <div class="profile-div">
          <img id="preview" src="../static/img/profile-basic.png">
          <input type="file" name="dynamicFile" id="dynamicFile" onchange="readURL(this);">
            <label for="dynamicFile"></label>
          </div>
      <button class="profile-save-btn" type="button" onclick="fileUpload();">저장</button>
        </div>
      </div>

      <div class="form-div">
        <label for="userid" class="form-item" >아이디</label>
        <div class="form-guide">
          <input type="text" name="userid" id="userid" placeholder="아이디를 입력해주세요" required onchange="changeId()" onkeyup="idInputCheck(this, 10);">
          <p class="guide-id guide"></p>
        </div>
        <button type="button" class="check-btn" onclick="overlapId()">중복확인</button>
      </div>

      <div class="form-div">
        <label for="pw" class="form-item">비밀번호</label>
        <input type="password" name="pw" id="pw" placeholder="비밀번호를 입력해주세요" required onkeyup="checkPw(this);">
      </div>

      <div class="form-div">
        <label for="pw" class="form-item">비밀번호 확인</label>
        <div class="form-guide">
          <input type="password" id="pw-confirm" placeholder="비밀번호를 한번 더 입력해주세요" required onkeyup="checkPw(this);">
          <p class="guide-pw guide"></p>
        </div>
      </div>

      <div class="form-div">
        <label for="nickname" class="form-item">닉네임</label>
        <input type="text" name="nickname" id="nickname" required onkeyup="charCheck(this, max);" placeholder="닉네임을 입력해주세요">
        <button type="button" class="check-btn" onclick="overlapNick()">중복확인</button>
      </div>

      <div class="form-div">
        <label for="address" class="form-item">주소</label>
        <!-- <input type="text" name="address" id="address" required> -->
        <!-- <input id="member_post"  type="text" placeholder="Zip Code" readonly onclick="findAddr()"> -->
        <input id="address" name="address" type="text" placeholder="주소를 선택해주세요" readonly > <br>
        <button type="button" class="check-btn" onclick="findAddr()">주소검색</button>
        <!-- <input type="text" placeholder="Detailed Address"> -->
      </div>
      <br>

      <div class="form-div-btn"> 
        <!-- 버튼 타입 button submit? -->
        <button id="disBtn" type="button" onclick="register();" class="check-btn" disabled>가입하기</button>

      </div>
    </fieldset>
  </form>

  <script>
    let useridInput = document.querySelector('#userid');
    let pwInput = document.querySelector('#pw');
    let pwConfirm = document.querySelector('#pw-confirm');
    let useridGuide = document.querySelector('.guide-id');
    let userpwGuide = document.querySelector('.guide-pw');
    let disBtn = document.querySelector('#disBtn')

  function changeId() {

    disBtn.disabled = true;
  }
  // let check = false;
function overlapId() {
  
  const form = document.forms['register-form'];
    console.log(form.userid.value);
    axios({
      method: 'POST',
      url: '/overlapId',
      data: {
        userid: form.userid.value,
      },
    })
      .then((res) => {
        return res.data;
      })
      .then((data) => { // true, false
        console.log('중복된 아이디인가요? ', data)
        if (data) {
          alert('중복된 아이디입니다')
          disBtn.disabled = true;
        } else {
          console.log('distbtnvalue', disBtn.dataset.value);
          alert('사용가능한 아이디입니다')
          if (disBtn.dataset.value){
            disBtn.disabled = false;
          } else {
            disBtn.setAttribute('data-value', true);
          }

        }
      });
  }

  function overlapNick() {

  const form = document.forms['register-form'];
    console.log(form.userid.value);
    axios({
      method: 'POST',
      url: '/overlapNick',
      data: {
        nickname: form.nickname.value,
      },
    })
      .then((res) => {
        return res.data;
      })
      .then((data) => { // true, false
        console.log('중복된 닉네임인가요? ', data)
        if (data) {
          alert('중복된 닉네임입니다')
          disBtn.disabled = true;

        } else {
          alert('사용가능한 닉네임입니다')
          if (disBtn.dataset.value){
            disBtn.disabled = false;
          } else {
            disBtn.setAttribute('data-value', true);
          }
        }
      });
  }

    function charCheck(obj) {
      // 특수문자 판별
      var specialChar = /[ \{\}\[\]\/?.,;:|\)*~`!^\-_+┼<>@\#$%&\'\"\\\(\=]/gi;

      // 배열에서 하나씩 값을 비교
      if (specialChar.test(obj.value)) {
        // 값이 일치하면 문자를 삭제
        obj.value = obj.value.substring(0, obj.value.length - 1);
      }
    };

    // maxlength 넘었을 때 텍스트를 잘라서 value값에 넣어줌
    function handleInputLength(el, max) {
      if (el.value.length > max) {
        el.value = el.value.substr(0, max);
      }
    };

    function idInputCheck(obj, max) {
      charCheck(obj);
      handleInputLength(obj, max);
      
      // 조건을 만족하지 않으면 가이드 보임 
      if (useridInput.value.length = 0 || useridInput.value.length < 3) {
        useridGuide.innerText = '아이디는 3 - 10자로 만들어주세요'
        // 6자 이상 16자 이하로 특수문자 제외
      } else {
        useridGuide.innerText = ''
      }
    };

    function fileUpload() {
      console.log('click fileUpload')

      // 멀티미디어 데이터는 비동기 데이터를 보여줄 때 폼 데이터를 만들어서 함
      const formData = new FormData(); // 폼 객체 생성
      const file = document.getElementById('dynamicFile'); // file input
      console.dir(file.files[0]); // 파일 input에 들어간 파일 정보

      // formData.append(name, value);
      // input의 name과 input의 value
      formData.append('dynamicFile', file.files[0])
      
      // axios 통신
      axios({
        method: 'POST',
        url: '/dynamicFile',
        data: formData,
        headers: {
          'Content-Type': 'multipart/form-data', // enctype: "multipart/form-data"
        },
      }).then(function(res) {
        // res : 클라이언트의 POST /dynamicFile 요청을 보낸 응답 결과
        document.getElementById('preview').src = `/uploads/${res.data.filename}`
        alert('프로필 저장이 완료되었어요!')
      })
    }

    // 이미지 미리보기
    function readURL(input) {
      if (input.files[0]) {
        let reader = new FileReader();
        reader.onload = function(obj) {

          document.getElementById('preview').src = obj.target.result;
        };

        reader.readAsDataURL(input.files[0]);
      } else {
        document.getElementById('preview').src = "/static/img/profileBasic.png";
      }
      document.querySelector('.profile-save-btn').style.display = 'block'

    }

    // 비밀번호 확인
    function checkPw() {
      console.log(pwInput.value)
      console.log(pwConfirm.value)
      if (pwInput.value != pwConfirm.value){
        userpwGuide.innerText = '비밀번호를 확인해주세요'
      } else {
        userpwGuide.innerText = ''
      }
    };

    

    // 주소찾기 
    function findAddr() {
      new daum.Postcode({
        oncomplete: function(data) {
          console.log(data);
          // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.
          // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
          // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
          var roadAddr = data.roadAddress; // 도로명 주소 변수
          var jibunAddr = data.jibunAddress; // 지번 주소 변수
          // 우편번호와 주소 정보를 해당 필드에 넣는다.
          // document.getElementById('member_post').value = data.zonecode;
          if (roadAddr !== '') {
            document.getElementById("address").value = roadAddr;
          } else if (jibunAddr !== '') {
            document.getElementById("address").value = jibunAddr;
          }
        }
      }).open();
    }

    function register() {
      const form = document.forms['register-form'];
      console.log(form)
      if (form.userid.value == '' || form.pw.value == '' || form.nickname.value == '' || form.address.value == '' ){
        return alert('값을 입력해주세요')}
 
      axios({
          method: 'POST',
          url: '/signup',
          data: {
            profile: document.getElementById('preview').src,
            userid: form.userid.value,
            pw: form.pw.value,
            nickname: form.nickname.value,
            address: form.address.value,
          },
        })
        .then((res) => {
          console.log(res);
          console.log(res.data);
          return res.data;
        })
        .then((data) => {
          // (1) alert 띄우기
          alert('회원이 되신 것을 축하해요!');
          // (2) 가입 성공시 로그인 페이지로 이동
          // document.location.href란?
          // javascript에서 페이지 이동할 수 있는 방법
          // document 객체를 사용하기 때문에 프론트에서 사용 가능
          form.userid.value = ''
          form.pw.value = ''
          form.nickname.value = ''
          form.address.value = ''
          const disBtn = document.querySelector('#disBtn')
          disBtn.disabled = true;
          document.location.href = '/login';
        });
    }
  </script>
</body>

</html>